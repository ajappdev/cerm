{% extends "base.html" %}
{% load i18n %}
{% load humanize %}
{% load static %}

{% block page_content %}


<div class="container">


    <div id="load_div" class="hidden" style="text-align:center;">
        <img src="{% static 'assets/img/load.gif' %}">
    </div>
    <div id="div_form">
    <div class="row">
        <div class="col-lg-3 col-12 col-md-12">
            <div id="upload-div h_100">
                <div id="upload-passport">
                    {% include 'customer/widgets/upload-id.html' %}
                </div>
            </div>    
        </div>
        <div class="col-lg-6 col-12 col-md-12">
            <div class="row">
                <div class="col-lg-6 col-12 col-md-12">
                    <div class="form-group mb-3">
                        <label for="customer_sex" class="form-label">{% trans "Sexe" %}</label>
                        <select class="form-control" id="customer_sex" name="customer_sex">
                            <option value=""></option>
                            <option value="M">{% trans "Masculin" %}</option>
                            <option value="F">{% trans "Feminin" %}</option>
                        </select>
                    </div>
                </div>
                <div class="col-lg-6 col-12 col-md-12">
                    <div class="form-group mb-3">
                        <label for="customer_name" class="form-label">{% trans "Nom complet" %}</label>
                        <input type="text" value="{{customer.complete_name}}" class="form-control" id="customer_name" name="customer_name">
                    </div>
                </div>
                <div class="col-lg-6 col-12 col-md-12">
                    <div class="form-group mb-3">
                        <label for="customer_nationality" class="form-label">{% trans "Nationalité" %}</label>
                        <input type="text" value="{{customer.nationality}}" class="form-control" id="customer_nationality" name="customer_nationality">
                    </div>
                </div>
                <div class="col-lg-6 col-12 col-md-12">
                    <div class="form-group mb-3">
                        <label for="customer_birth" class="form-label">{% trans "Date de naissance" %}</label>
                        <input type="text" class="datepicker form-control" id="customer_birth" name="customer_birth">
                    </div>
                </div>
                <div class="col-lg-4 col-12 col-md-12">
                    <div class="form-group mb-3">
                        <label for="customer_type" class="form-label">{% trans "Type<br>de document" %}</label>
                        <input value="{{customer.identity_type}}" disabled type="text" class="form-control" id="customer_type" name="customer_type">
                    </div>
                </div>
                <div class="col-lg-4 col-12 col-md-12">
                    <div class="form-group mb-3">
                        <label for="customer_id" class="form-label">{% trans "Numéro<br>du document" %}</label>
                        <input value="{{customer.identity_number}}" type="text" class="form-control" id="customer_id" name="customer_id">
                    </div>
                </div>
                <div class="col-lg-4 col-12 col-md-12">
                    <div class="form-group mb-3">
                        <label for="customer_expire" class="form-label">{% trans "Expiration<br>du document" %}</label>
                        <input type="text" class="form-control datepicker" id="customer_expire" name="customer_expire">
                    </div>
                </div>
                <div class="col-lg-6 col-12 col-md-12">
                    <div class="form-group mb-3">
                        <label for="customer_phone" class="form-label">{% trans "Téléphone" %}</label>
                        <input value="{{customer.phone}}" type="text" class="form-control" id="customer_phone" name="customer_phone">
                    </div>
                </div>
                <div class="col-lg-6 col-12 col-md-12">
                    <div class="form-group mb-3">
                        <label for="customer_email" class="form-label">{% trans "Email" %}</label>
                        <input value="{{customer.email}}" type="text" class="form-control" id="customer_email" name="customer_email">
                    </div>
                </div>
                <div class="col-lg-12 col-12 col-md-12">
                    <div class="form-group mb-3">
                        <label for="customer_address" class="form-label">{% trans "Adresse" %}</label>
                        <input value="{{customer.address}}" type="text" class="form-control" id="customer_address" name="customer_address">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-12 col-md-12">
            <div class="customer_notes col-lg-12 col-12 col-md-12 mb-3">
                <p class="customer_notes_title">{% trans "Notes sur le client" %}</p>
                <div style="padding: 10px; max-height: 100px; overflow-y: auto;">
                    {% for note in customer_notes %}
                    <p class="customer_note"><strong>{{ note.created_at|date:"Y-m-d" }}</strong> : {{ note.note }}</p>
                    {% endfor %}
                </div>
            </div>
            <div class="col-lg-12 col-12 col-md-12">
                <div class="form-group mb-3">
                    <label for="customer_note" class="form-label">{% trans "Nouvelle Note" %}</label>
                    <textarea style="resize:none;" type="text" class="form-control" id="customer_note" name="customer_note"></textarea>
                </div>
            </div>
        </div>
        <div class="mt-4" style="text-align:center;">
            <button id="save_customer" class="next_back_buttons btn btn-lg btn-success"><i class="fas fa-save"></i> {% trans "Enregistrer" %}</button>
        </div>
    </div>
    </div>
</div>


<script
  src="https://code.jquery.com/jquery-3.6.1.js"
  integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI="
  crossorigin="anonymous"></script>

<link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

<script>
    
var cus_id = "{{customer.id|safe}}"

//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
/////////////////////////////AT LOAD//////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////

function check_file_upload()
{
    if (parseInt(id_card_uploaded) >= 1 && $("#customer_type_identity").val() != "") 
    {
        $("#upload_next").attr("disabled", false)
    }else
    {
        $("#upload_next").attr("disabled", true)
    }
}

$(function() {
    $( ".datepicker" ).datepicker(
        {
        dateFormat: "yy-mm-dd"
        });
        $("#customer_birth").datepicker("setDate", "{{customer.date_of_birth|date:'Y-m-d'}}");
        $("#customer_expire").datepicker("setDate", "{{customer.identity_expire_date|date:'Y-m-d'}}");
    });

$("#customer_sex").val("{{customer.sex}}")

//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
////////////////////////CHANGE EVENTS//////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////

$(document).on("change", "#customer_type_identity", function() {

    if (parseInt(id_card_uploaded) >= 1 && $("#customer_type_identity").val() != "") 
    {
        $("#upload_next").attr("disabled", false)
    }else
    {
        $("#upload_next").attr("disabled", true)
    }

});

//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
////////////////////////CLICK EVENTS//////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////


$(document).on("click", "#upload_next", function() {

    if (parseInt(id_card_uploaded) >= 1 && $("#customer_type_identity").val() != "") 
    {

    data_dict = {
        "action": "upload_identity_files_add_customer",
    }

    $.ajax({
        headers: {
            "X-CSRFToken": getCookie("csrftoken")
        },
        type: 'POST',
        processData: false,
        contentType: false,
        url: "{% url 'ajax_calls' %}",
        data: JSON.stringify(data_dict),
        success: function(response) {
            fill_form(response['id_reading'])
        }
    })
    }

});

$(document).on("click", "#save_customer", function() {

if (validate_form() == true)
    {
        data_dict = {
            "action": "save_customer",
            "customer_name": $("#customer_name").val(),
            "customer_nationality": $("#customer_nationality").val(),
            "customer_id": $("#customer_id").val(),
            "cus_id": cus_id,
            "customer_birth": $("#customer_birth").val(),
            "customer_type": $("#customer_type").val(),
            "customer_expire": $("#customer_expire").val(),
            "customer_address": $("#customer_address").val(),
            "customer_phone": $("#customer_phone").val(),
            "customer_email": $("#customer_email").val(),
            "customer_note": $("#customer_note").val(),
            "customer_sex": $("#customer_sex").val(),
        }
        $("#load_div").show("")
        $("#div_form").hide("")

        $.ajax({
            headers: {
                "X-CSRFToken": getCookie("csrftoken")
            },
            type: 'POST',
            processData: false,
            contentType: false,
            url: "{% url 'ajax_calls' %}",
            data: JSON.stringify(data_dict),
            success: function(response) {
                if (response['error'] != "0")
                {
                    Swal.fire({
                        icon: 'error',
                        title: translate_js('Une erreur est survenue!', "FR"),
                        position: 'center',
                        showConfirmButton: false,
                        text: response['error_text'],
                    })
                    $("#load_div").hide("");
                    $("#div_form").show("");
                }else
                {
                    document.location.href = '/customers/?success_message=updated'
                }
            }
        })
    }else
    {
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            position: 'center',
            showConfirmButton: false,
            timer: 1500,
            text: translate_js('Merci de remplire les champs indiquées en rouge !', "FR"),
        })
    }
});


//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
////////////////////////FUNCTIONS/////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////

function fill_form(content)
{
    $("#customer_name").val(content['surname'] + " " + content['name']);
    $("#customer_nationality").val(content['nationality'] + " - " + content['country']);
    $("#customer_id").val(content['document_number']);
    $("#customer_birth").datepicker("setDate", content['birth_date']);
    $("#customer_expire").datepicker("setDate", content['expiry_date']);
    $("#customer_type").val($("#customer_type_identity option:selected").text());
    $("#customer_sex").val(content['sex']);
    $("#div_form").show("");
    $("#load_div").hide("");
}

function validate_form()
{
    return_value = true
    if ($("#customer_name").val() == "")
    {
        $("#customer_name").css("background-color", "#ffc3c3");
        return_value = false
    }
    if ($("#customer_nationality").val() == "")
    {
        $("#customer_nationality").css("background-color", "#ffc3c3")
        return_value = false
    }
    if ($("#customer_id").val() == "")
    {
        $("#customer_id").css("background-color", "#ffc3c3")
        return_value = false
    }
    if ($("#customer_birth").val() == "")
    {
        $("#customer_birth").css("background-color", "#ffc3c3")
        return_value = false
    }
    if ($("#customer_type").val() == "")
    {
        $("#customer_type").css("background-color", "#ffc3c3")
        return_value = false
    }
    if ($("#customer_expire").val() == "")
    {
        $("#customer_expire").css("background-color", "#ffc3c3")
        return_value = false
    }
    if ($("#customer_sex").val() == "")
    {
        $("#customer_sex").css("background-color", "#ffc3c3")
        return_value = false
    }
    if ($("#customer_phone").val() == "")
    {
        $("#customer_phone").css("background-color", "#ffc3c3")
        return_value = false
    }
    return return_value
}

</script>


{% endblock %}